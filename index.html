<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Generator zaproszeń ślubnych - stwórz eleganckie zaproszenia na swój wyjątkowy dzień">
  <meta name="theme-color" content="#6c5b7b">
  <title>Zaproszenia Ślubne | Generator</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;1,400&family=Montserrat:wght@300;400;500;600&family=Italiana&family=Cormorant:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- Zmienne CSS --- */
    :root {
      --primary: #6c5b7b;
      --primary-light: #8d7b9d;
      --primary-dark: #554762;
      --secondary: #c79c59;
      --secondary-light: #e3b870;
      --secondary-dark: #a87f40;
      --neutral-100: #ffffff;
      --neutral-200: #f8f9fa;
      --neutral-300: #e9ecef;
      --neutral-400: #dee2e6;
      --neutral-500: #adb5bd;
      --neutral-600: #6c757d;
      --neutral-700: #495057;
      --neutral-800: #343a40;
      --neutral-900: #212529;
      --success: #3d8f6e;
      --danger: #e74c3c;
      --warning: #f0ad4e;
      --font-primary: 'Playfair Display', serif;
      --font-secondary: 'Montserrat', sans-serif;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 16px rgba(0,0,0,0.1);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --transition: all 0.3s ease;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-xxl: 48px;
    }

    /* --- Reset i Podstawowe Style --- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-secondary);
      background-color: var(--neutral-200);
      color: var(--neutral-800);
      line-height: 1.6;
      min-height: 100vh;
      padding: var(--spacing-lg);
      position: relative; /* Dla pozycjonowania popupImage */
    }

    /* --- Typografia --- */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-primary);
      margin-bottom: var(--spacing-md);
      color: var(--neutral-900);
      font-weight: 500;
    }

    h1 {
      font-size: 2.5rem;
      text-align: center;
      margin-bottom: var(--spacing-xl);
      position: relative;
      padding-bottom: var(--spacing-md);
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 2px;
      background: linear-gradient(to right, transparent, var(--secondary), transparent);
    }

    /* --- Klasy Użytkowe --- */
    .sr-only { /* Ukrywa element wizualnie, ale dostępny dla czytników ekranu */
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* --- Kontenery i Layout --- */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: var(--neutral-100);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
    }

    .main-container {
      display: flex;
      min-height: 700px;
    }

    .sidebar {
      width: 35%;
      background-color: var(--neutral-100);
      padding: var(--spacing-xl);
      border-right: 1px solid var(--neutral-300);
      display: flex;
      flex-direction: column;
    }

    .content-area {
      width: 65%;
      position: relative;
      background-color: var(--neutral-200); /* Tło dla obszaru podglądu */
    }

    /* --- Przyciski --- */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-secondary);
      font-weight: 500;
      font-size: 0.95rem;
      text-align: center;
      text-decoration: none;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
      user-select: none; /* Zapobiega zaznaczaniu tekstu przycisku */
    }

    .btn-icon {
      display: inline-flex; /* Użycie inline-flex zamiast inline */
      margin-right: 8px;
      vertical-align: middle; /* Lepsze wyrównanie z tekstem */
    }

    .btn-primary {
      background-color: var(--primary);
      color: var(--neutral-100);
    }

    .btn-primary:hover, .btn-primary:focus-visible { /* Użycie focus-visible dla lepszej dostępności */
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      outline: none; /* Usuń domyślny outline dla focus-visible */
    }

     .btn-primary:focus-visible { /* Dodaj własny styl focus dla dostępności */
        box-shadow: 0 0 0 3px rgba(108, 91, 123, 0.4);
     }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* Style dla .btn-secondary, .btn-success analogicznie z :focus-visible */
    .btn-secondary { background-color: var(--neutral-600); color: var(--neutral-100); }
    .btn-secondary:hover, .btn-secondary:focus-visible { background-color: var(--neutral-700); transform: translateY(-2px); box-shadow: var(--shadow-md); outline: none; }
    .btn-secondary:focus-visible { box-shadow: 0 0 0 3px rgba(108, 117, 125, 0.4); }

    .btn-success { background-color: var(--success); color: var(--neutral-100); }
    .btn-success:hover, .btn-success:focus-visible { background-color: #317557; transform: translateY(-2px); box-shadow: var(--shadow-md); outline: none; }
    .btn-success:focus-visible { box-shadow: 0 0 0 3px rgba(61, 143, 110, 0.4); }

    .btn-lg { padding: 12px 28px; font-size: 1.1rem; }
    .btn-block { display: block; width: 100%; }

    /* --- Formularze (Wyszukiwarka) --- */
    .input-group {
      position: relative;
      margin-bottom: var(--spacing-md);
    }

    .input-icon {
      position: absolute;
      top: 50%;
      left: 14px;
      transform: translateY(-50%);
      color: var(--neutral-600);
      pointer-events: none; /* Ikona nie przechwytuje kliknięć */
    }

    .search-box {
      width: 100%;
      padding: 12px 12px 12px 40px; /* Dostosowane paddingi */
      border: 1px solid var(--neutral-400);
      border-radius: var(--radius-sm);
      font-family: var(--font-secondary);
      font-size: 0.95rem;
      background-color: var(--neutral-100);
      transition: var(--transition);
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(108, 91, 123, 0.2);
    }

    .search-box::placeholder {
      color: var(--neutral-500);
    }

    /* --- Lista Gości --- */
    .guest-list {
      flex: 1; /* Rozciąga się, aby wypełnić dostępną przestrzeń */
      margin: var(--spacing-md) 0;
      overflow-y: auto; /* Scrollbar tylko gdy potrzebny */
      border: 1px solid var(--neutral-300);
      border-radius: var(--radius-sm);
      background-color: var(--neutral-100);
    }

    /* Stylizacja paska przewijania dla WebKit (Chrome, Safari) */
    .guest-list::-webkit-scrollbar { width: 8px; }
    .guest-list::-webkit-scrollbar-track { background: var(--neutral-200); border-radius: var(--radius-sm); }
    .guest-list::-webkit-scrollbar-thumb { background-color: var(--neutral-500); border-radius: var(--radius-sm); }
    .guest-list::-webkit-scrollbar-thumb:hover { background-color: var(--neutral-600); }

    .guest-item {
      padding: var(--spacing-md);
      cursor: pointer;
      border-bottom: 1px solid var(--neutral-300);
      transition: background-color 0.2s ease, border-left-color 0.2s ease; /* Skrócona definicja przejścia */
      position: relative; /* Dla pseudoelementu ::after */
      border-left: 3px solid transparent; /* Domyślna przezroczysta ramka dla płynnego przejścia */
      margin-left: -3px; /* Kompensacja dla border-left */
      padding-left: calc(var(--spacing-md) + 3px); /* Dostosowanie paddingu */
    }

    .guest-item:last-child {
      border-bottom: none;
    }

    .guest-item:hover {
      background-color: var(--neutral-200);
    }

    .guest-item.selected {
      background-color: rgba(108, 91, 123, 0.1);
      border-left: 3px solid var(--primary);
      font-weight: 500; /* Lekkie pogrubienie dla zaznaczonego */
    }

    .guest-item.selected::after { /* Wskaźnik zaznaczenia */
      content: '';
      position: absolute;
      right: var(--spacing-md);
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: var(--primary);
    }

    /* --- Pasek Statusu --- */
    .status-bar {
      margin-top: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--neutral-200);
      border-left: 3px solid var(--primary);
      border-radius: var(--radius-sm);
      font-size: 0.95rem;
      color: var(--neutral-700);
    }

    /* --- Podgląd (iframe) --- */
    .preview-frame {
      width: 100%;
      height: 100%;
      border: none;
      background-color: var(--neutral-100); /* Tło gdy iframe jest pusty */
    }

    /* --- Popup Obrazek --- */
    .popup-image {
      position: fixed; /* Pozycjonowany względem viewportu */
      z-index: 9999;
      border: 5px solid var(--neutral-100);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      transition: transform 0.3s ease, opacity 0.3s ease; /* Dodane przejście opacity */
      display: none; /* Domyślnie ukryty */
      max-width: 250px;
      max-height: 250px;
      transform-origin: center;
      opacity: 0; /* Domyślnie przezroczysty */
      pointer-events: none; /* Nie przechwytuje zdarzeń myszy */
    }

    .popup-image.show {
      display: block;
      opacity: 1; /* Płynne pojawianie się */
      animation: pulse 0.6s ease-out; /* Krótsza, subtelniejsza animacja */
    }

    @keyframes pulse {
      0% { transform: scale(0.8); }
      70% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* --- Tytuły Sekcji --- */
    .section-title {
      font-size: 1.25rem;
      color: var(--neutral-800);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--neutral-300);
    }

    /* --- Kontrolki (przyciski w sidebar) --- */
    .controls {
      display: flex;
      justify-content: space-between; /* Rozmieszcza przyciski */
      margin-bottom: var(--spacing-md);
      gap: var(--spacing-md); /* Odstęp między przyciskami */
    }

    /* --- Style Quizu --- */
    .quiz-container {
      padding: var(--spacing-lg);
      background-color: var(--neutral-100);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      animation: fadeIn 0.5s ease;
      /* Ukryty domyślnie, kontrolowany przez JS */
      /* display: none; */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .quiz-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-lg);
    }

    .quiz-title {
      font-size: 1.5rem;
      margin: 0; /* Usuwa domyślny margines nagłówka */
    }

    .quiz-question {
      margin-bottom: var(--spacing-xl);
      animation: slideInRight 0.5s ease;
      /* Ukryte domyślnie (oprócz pierwszego), kontrolowane przez JS */
      /* display: none; */
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .quiz-question h3 {
      font-size: 1.2rem;
      margin-bottom: var(--spacing-md);
      color: var(--neutral-800);
      font-weight: 500; /* Lepsza czytelność */
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .quiz-option {
      background-color: var(--neutral-100);
      border: 1px solid var(--neutral-300);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      text-align: left;
      font-family: var(--font-secondary);
      font-size: 1rem;
      position: relative; /* Dla pseudoelementu ::before */
      padding-left: 45px; /* Miejsce na literkę */
      color: var(--neutral-800); /* Kolor tekstu opcji */
    }

    .quiz-option:hover {
      background-color: rgba(108, 91, 123, 0.05);
      border-color: var(--primary-light);
    }

    .quiz-option::before { /* Literki A, B, C... */
      content: attr(data-letter); /* Użyj atrybutu data-letter dla dynamicznych literek */
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: var(--primary-light);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    /* Usunięte statyczne :nth-child dla literek, będą dodawane przez JS */

    .quiz-option.correct {
      background-color: rgba(61, 143, 110, 0.1);
      border-color: var(--success);
      color: var(--success); /* Podkreślenie koloru */
      font-weight: 600;
    }
    .quiz-option.correct::before {
      background-color: var(--success);
    }

    .quiz-option.incorrect {
      background-color: rgba(231, 76, 60, 0.1);
      border-color: var(--danger);
      color: var(--danger); /* Podkreślenie koloru */
    }
     .quiz-option.incorrect::before {
      background-color: var(--danger);
    }

    .quiz-option:disabled { /* Styl dla zablokowanych opcji po odpowiedzi */
        cursor: not-allowed;
        opacity: 0.7;
    }


    .quiz-footer {
      display: flex;
      justify-content: space-between; /* Rozmieszczenie elementów w stopce */
      align-items: center; /* Wyrównanie w pionie */
      margin-top: var(--spacing-xl);
    }

    .quiz-progress-container { /* Dodatkowy kontener dla paska i etykiety */
        width: 100%;
        margin-bottom: var(--spacing-lg);
    }

    .quiz-progress-label {
        font-size: 0.9rem;
        color: var(--neutral-600);
        margin-bottom: var(--spacing-xs);
        text-align: right;
    }

    .quiz-progress {
      width: 100%;
      height: 6px;
      background-color: var(--neutral-300);
      border-radius: 3px;
      /* margin-top: var(--spacing-xs); - Usunięty, jest w kontenerze */
      overflow: hidden; /* Aby zaokrąglone rogi działały z paskiem wewnątrz */
    }

    .quiz-progress-bar {
      height: 100%;
      background-color: var(--primary);
      transition: width 0.5s ease;
      border-radius: 3px; /* Zaokrąglenie pasujące do kontenera */
    }

    /* --- Kontener Pobierania --- */
    .download-container {
      text-align: center;
      padding: var(--spacing-xxl) var(--spacing-xl);
      background-color: rgba(61, 143, 110, 0.05);
      border-radius: var(--radius-md);
      animation: fadeInUp 0.8s ease;
      /* Ukryty domyślnie, kontrolowany przez JS */
      /* display: none; */
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .download-heading {
      font-size: 1.5rem;
      color: var(--success);
      margin-bottom: var(--spacing-lg);
    }

    .download-icon {
      display: block;
      margin: 0 auto var(--spacing-lg);
      font-size: 4rem;
      color: var(--success);
    }

    .download-actions {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
      max-width: 300px;
      margin: 0 auto;
    }

    /* --- Modal (nieużywany w kodzie JS, ale ostylowany) --- */
    .modal-backdrop { /* ... style dla modala ... */ }
    .modal { /* ... style dla modala ... */ }
    /* ... reszta stylów modala ... */

    /* --- Dodatkowe animacje --- */
    .animate-float {
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-8px); } /* Subtelniejszy efekt */
      100% { transform: translateY(0px); }
    }

    /* --- Style Responsywne --- */
    @media (max-width: 1200px) {
      body { padding: var(--spacing-md); }
      .main-container { flex-direction: column; min-height: auto; }
      .sidebar, .content-area { width: 100%; }
      .sidebar { border-right: none; border-bottom: 1px solid var(--neutral-300); }
      .content-area { height: 60vh; min-height: 500px; } /* Ustawienie wysokości dla podglądu */
    }

    @media (max-width: 768px) {
      h1 { font-size: 1.8rem; }
      body { padding: var(--spacing-sm); }
      .quiz-option { padding: var(--spacing-md) var(--spacing-md) var(--spacing-md) 40px; }
      .quiz-question h3 { font-size: 1.1rem; }
      .sidebar { padding: var(--spacing-md); }
    }

    @media (max-width: 576px) {
      h1 { font-size: 1.5rem; }
      .controls { flex-direction: column; gap: var(--spacing-sm); }
      /* Usunięto .btn { width: 100%; } - przyciski mogą mieć różną szerokość */
      .quiz-option::before { width: 20px; height: 20px; font-size: 0.75rem; }
    }

    /* --- Style do Druku --- */
    @media print {
      body { background: none; padding: 0; }
      .container, .sidebar, .controls, .search-box, h1, .quiz-container, .download-container, .status-bar, .popup-image, body > h1 {
        display: none !important; /* Ukryj wszystkie elementy interfejsu */
      }
      .main-container { display: block; min-height: auto; }
      .content-area { width: 100%; height: auto; }
      .preview-frame { /* Upewnij się, że ramka zajmuje całą stronę */
          width: 100%;
          height: 100vh; /* Można dostosować, zależy od zawartości iframe */
      }
      /* Style specyficzne dla druku zawartości iframe powinny być wewnątrz szablonu */
    }

    /* UWAGA: Style .invitation-template poniżej nie są używane przez główną stronę, */
    /* ale są częścią szablonu wstrzykiwanego do iframe przez JS. */
    /* Zostawiam je tu dla kompletności, ale można je usunąć z tego bloku <style>. */
    /*
    .invitation-template { ... }
    .invitation-wrapper { ... }
    .invitation { ... }
    .border-frame { ... }
    */

  </style>
</head>
<body>
  <!-- Główny nagłówek aplikacji -->
  <h1 class="animate-float">Generator Zaproszeń Ślubnych</h1>

  <div class="container">
    <div class="main-container">
      <!-- Panel boczny (Sidebar) -->
      <aside class="sidebar">
        <!-- Przyciski kontrolne -->
        <div class="controls">
          <button class="btn btn-primary" id="downloadButton" title="Rozwiąż quiz, aby odblokować pobieranie">
            <span class="btn-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
            </span>
            Pobierz wszystkie
          </button>
        </div>

        <!-- Wyszukiwarka gości -->
        <div class="input-group">
          <span class="input-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>
          </span>
          <input type="text" id="searchBox" class="search-box" placeholder="Wyszukaj gościa..." aria-label="Wyszukaj gościa">
        </div>

        <!-- Lista gości -->
        <div class="guest-list" id="guestList" aria-live="polite">
          <!-- Dynamicznie wypełniana przez JavaScript -->
        </div>

        <!-- Pasek statusu -->
        <div class="status-bar" id="status">
          Wybierz gościa z listy, aby zobaczyć podgląd zaproszenia.
        </div>

        <!-- Kontener Quizu (domyślnie ukryty) -->
        <div class="quiz-container" id="quizContainer" style="display: none;">
          <div class="quiz-header">
            <h2 class="quiz-title">Quiz o Szwagrze</h2>
            <button class="btn btn-secondary" id="backToListButton" title="Wróć do listy zaproszeń">
              <span class="btn-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
              </span>
              Wróć
            </button>
          </div>

           <div class="quiz-progress-container">
                <div class="quiz-progress-label" id="quizProgressLabel">Pytanie 1 / 10</div>
                <div class="quiz-progress">
                    <div class="quiz-progress-bar" id="quizProgressBar" style="width: 10%;"></div>
                </div>
            </div>

          <!-- Pytania Quizu (dynamicznie pokazywane/ukrywane przez JS) -->
          <!-- Pytanie 1 -->
          <div class="quiz-question" data-question-index="0">
            <h3>1. Kto jest najlepszym szwagrem na całym świecie?</h3>
            <div class="quiz-options">
              <button class="quiz-option" data-correct="true" data-letter="A">Dawid Stelmach</button>
              <button class="quiz-option" data-correct="false" data-letter="B">Brad Pitt</button>
              <button class="quiz-option" data-correct="false" data-letter="C">Jakiś inny typek</button>
            </div>
          </div>
          <!-- Pytanie 2 -->
          <div class="quiz-question" data-question-index="1" style="display: none;">
            <h3>2. Jeśli Dawid Stelmach byłby zwierzęciem, to byłby:</h3>
            <div class="quiz-options">
              <button class="quiz-option" data-correct="false" data-letter="A">Leniwcem, bo ciągle odpoczywa</button>
              <button class="quiz-option" data-correct="true" data-letter="B">Lwem, królem zwierząt</button>
              <button class="quiz-option" data-correct="false" data-letter="C">Orłem, bo zawsze patrzy z góry</button>
            </div>
          </div>
          <!-- ... Pozostałe pytania (3-10) analogicznie ... -->
          <div class="quiz-question" data-question-index="2" style="display: none;">
             <h3>3. Co Dawid Stelmach robi najlepiej?</h3>
             <div class="quiz-options">
                 <button class="quiz-option" data-correct="false" data-letter="A">Śpi do południa</button>
                 <button class="quiz-option" data-correct="false" data-letter="B">Opowiada kiepskie dowcipy</button>
                 <button class="quiz-option" data-correct="true" data-letter="C">Wszystko! Jest w tym absolutnym mistrzem</button>
             </div>
          </div>
          <div class="quiz-question" data-question-index="3" style="display: none;">
              <h3>4. Jaki superbohater najbardziej przypomina Dawida Stelmacha?</h3>
              <div class="quiz-options">
                  <button class="quiz-option" data-correct="true" data-letter="A">Superman, bo ma nadludzkie umiejętności</button>
                  <button class="quiz-option" data-correct="false" data-letter="B">Batman, bo ciągle gdzieś znika</button>
                  <button class="quiz-option" data-correct="false" data-letter="C">Iron Man, bo lubi błyszczeć</button>
              </div>
          </div>
          <div class="quiz-question" data-question-index="4" style="display: none;">
              <h3>5. Gdyby Dawid Stelmach miał supermoc, to byłaby to:</h3>
              <div class="quiz-options">
                  <button class="quiz-option" data-correct="false" data-letter="A">Umiejętność zasypiania na zawołanie w każdej sytuacji</button>
                  <button class="quiz-option" data-correct="true" data-letter="B">Rozwiązywanie wszystkich problemów jednym spojrzeniem</button>
                  <button class="quiz-option" data-correct="false" data-letter="C">Magiczna zdolność znikania, gdy trzeba zmywać naczynia</button>
              </div>
          </div>
          <div class="quiz-question" data-question-index="5" style="display: none;">
              <h3>6. Dokończ zdanie: Dawid Stelmach jest tak przystojny, że...</h3>
              <div class="quiz-options">
                  <button class="quiz-option" data-correct="false" data-letter="A">Jego żona czasem się na niego patrzy</button>
                  <button class="quiz-option" data-correct="false" data-letter="B">Może ujść w tłumie niezauważony</button>
                  <button class="quiz-option" data-correct="true" data-letter="C">Słońce prosi go o autograf</button>
              </div>
          </div>
          <div class="quiz-question" data-question-index="6" style="display: none;">
              <h3>7. Jakby Dawid Stelmach był daniem, to byłby:</h3>
              <div class="quiz-options">
                  <button class="quiz-option" data-correct="false" data-letter="A">Zimnym kebabem z wczoraj</button>
                  <button class="quiz-option" data-correct="false" data-letter="B">Zwykłym kotletem schabowym</button>
                  <button class="quiz-option" data-correct="true" data-letter="C">Wykwintnym daniem z gwiazdką Michelin</button>
              </div>
          </div>
          <div class="quiz-question" data-question-index="7" style="display: none;">
              <h3>8. Największym talentem Dawida Stelmacha jest:</h3>
              <div class="quiz-options">
                  <button class="quiz-option" data-correct="false" data-letter="A">Umiejętność spania podczas ważnych rozmów</button>
                  <button class="quiz-option" data-correct="true" data-letter="B">Bycie najlepszym we wszystkim czego się dotknie</button>
                  <button class="quiz-option" data-correct="false" data-letter="C">Opowiadanie tych samych historii milion razy</button>
              </div>
          </div>
          <div class="quiz-question" data-question-index="8" style="display: none;">
              <h3>9. Co by się stało, gdyby Dawid Stelmach został prezydentem Polski?</h3>
              <div class="quiz-options">
                  <button class="quiz-option" data-correct="false" data-letter="A">Nic, zaspałby na zaprzysiężenie</button>
                  <button class="quiz-option" data-correct="false" data-letter="B">Wprowadziłby obowiązkowe leżakowanie zamiast pracy</button>
                  <button class="quiz-option" data-correct="true" data-letter="C">Polska stałaby się supermocarstwem w ciągu tygodnia</button>
              </div>
          </div>
          <div class="quiz-question" data-question-index="9" style="display: none;">
              <h3>10. Czy jesteś absolutnie pewien/pewna, że Dawid Stelmach jest najwspanialszym szwagrem wszech czasów?</h3>
              <div class="quiz-options">
                  <button class="quiz-option" data-correct="true" data-letter="A">Tak, jestem tego pewien jak niczego innego w życiu</button>
                  <button class="quiz-option" data-correct="true" data-letter="B">Oczywiście, to niepodważalny fakt naukowy</button>
                  <button class="quiz-option" data-correct="true" data-letter="C">Absolutnie! Dawid to legenda wśród szwagrów</button>
              </div>
          </div>


          <!-- Stopka Quizu (Wynik) -->
          <div class="quiz-footer">
            <div id="quizScoreContainer" style="display: none;">
              <span>Twój wynik: <strong id="quizScore">0/10</strong></span>
            </div>
            <!-- Można dodać przycisk "Następne pytanie" jeśli nie chcemy automatycznego przejścia -->
          </div>
        </div>

        <!-- Kontener Pobierania (domyślnie ukryty) -->
        <div class="download-container" id="downloadContainer" style="display: none;">
          <div class="download-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16"> <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/> <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z"/></svg>
          </div>
          <h3 class="download-heading">Dziękujemy za rozwiązanie quizu!</h3>
          <p>Teraz możesz pobrać wszystkie zaproszenia.</p>
          <div class="download-actions">
            <a href="#" class="btn btn-success btn-lg btn-block" id="finalDownloadButton" title="Pobierz ZIP ze wszystkimi zaproszeniami">
              <span class="btn-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
              </span>
              Pobierz plik ZIP
            </a>
            <button class="btn btn-secondary" id="backFromDownloadButton" title="Wróć do listy zaproszeń">
              <span class="btn-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/></svg>
              </span>
              Wróć do listy
            </button>
          </div>
        </div>
      </aside> <!-- Koniec .sidebar -->

      <!-- Obszar podglądu -->
      <main class="content-area" id="contentArea">
        <iframe id="previewFrame" class="preview-frame" title="Podgląd zaproszenia" src="about:blank"></iframe>
        <!-- Pusty src="about:blank" jest lepszy niż brak src -->
        <img id="popupImage" class="popup-image" src="" alt="Efekt wizualny">
      </main> <!-- Koniec .content-area -->
    </div> <!-- Koniec .main-container -->
  </div> <!-- Koniec .container -->

  <!-- Elementy Audio -->
  <!-- WAŻNE: Upewnij się, że folder 'dzwieki' istnieje i zawiera te pliki MP3 -->
  <!-- lub zmień ścieżki na poprawne. -->
  <audio id="sound1" src="dzwieki/065392_long-wet-fart-54798.mp3" preload="auto"></audio>
  <audio id="sound2" src="dzwieki/wet-fart-2-42358.mp3" preload="auto"></audio>
  <audio id="sound3" src="dzwieki/wet-fart-6139.mp3" preload="auto"></audio>
  <audio id="sound4" src="dzwieki/wet-fart-42422.mp3" preload="auto"></audio>

  <script>
    // Użycie 'DOMContentLoaded' zapewnia, że skrypt uruchomi się dopiero po załadowaniu całego HTML.
    document.addEventListener('DOMContentLoaded', () => {

      // --- Stałe i Zmienne Globalne ---
      const GUEST_LIST_DATA = [
        // Rodzina Pani Młodej
        "Rodziców Alicję oraz Sławomira Zawada", "Karolinę, Dawida oraz Izabelkę Stelmach", "Babcię Franię Gawlik",
        "Natalię oraz Aleksandra Zawadę", "Ciocię Beatę wraz z Krzysztofem Milerskim oraz Sylwią Gawlik",
        "Mateusza Gawlika oraz Gosię Krzywon", "Magdę Gawlik-Wrzeszcz oraz Filipa Wrzeszcz",
        "Jowitę Gawlik wraz z osobą towarzyszącą, Amelkę Chmiel oraz Adasia",
        "Rodziców chrzestnych Ciocię Ewę oraz Wujka Mietka Gawlik", "Anię oraz Krzyśka Staniek wraz z dziećmi",
        "Ciocię Aurelię Kohut wraz z osobą towarzyszącą",
        // Rodzina Pana Młodego
        "Rodziców Adriannę oraz Rafała wraz z Niną Dziedzic", "Babcię Łucję oraz Dziadka Stanisława Dziedzic",
        "Babcię Łucję Madzię", "Weronikę oraz Wojciecha Swobodów", "Łukasza oraz Magdalenę wraz z Ksawerym Madzia",
        "Beatę oraz Piotra wraz z Martyną i Dawidem Glajc", "Martę Dziedzic, Krzysztofa Orela wraz z Bartoszem",
        "Barbarę oraz Marka Pylicę", "Sylwię Krzemień-Kolasińską wraz z osobą towarzyszącą",
        // Znajomi
        "Rafała Nawodyło wraz z osobą towarzyszącą", "Wojciecha Foltyna wraz z osobą towarzyszącą",
        "Szymona Huplika wraz z osobą towarzyszącą", "Piotra Waliczka wraz z osobą towarzyszącą",
        "Annę oraz Krzysztofa Macura", "Krystiana Urbańskiego wraz z osobą towarzyszącą",
        "Arkadiusza Szczypkę oraz Agnieszki Fizek", "Wiktorię Malec oraz Przemysława Tomicę",
        "Aleksandrę oraz Eryka Sztwiertnię", "Arkadiusza Strokę oraz Marcina Żaka",
        "Victorię Ogorzelec oraz Michała Zontka", "Dominikę Obracaj oraz Mateusza Kumorka",
        "Weronikę oraz Dawida Jankowskich", "Klaudię oraz Jakuba Ferfeckich",
        "Agnieszkę Kucharską wraz z osobą towarzyszącą", "Magdalenę oraz Sebastiana Wróbel",
        "Magdalenę Grudzień wraz z osobą towarzyszącą", "Adama oraz Aleksandrę Woźnicę",
        "Mateusza Brudnego", "Łukasza Pszczółkę"
      ];

      const POPUP_IMAGES = [
          "https://aaaas.b-cdn.net/pupcia.jpg" // Upewnij się, że ten URL jest poprawny i dostępny
      ];

      const SOUND_ELEMENT_IDS = ['sound1', 'sound2', 'sound3', 'sound4'];
      const TOTAL_QUESTIONS = 10; // Liczba pytań w quizie

      // --- Elementy DOM ---
      const guestListElement = document.getElementById('guestList');
      const searchBox = document.getElementById('searchBox');
      const previewFrame = document.getElementById('previewFrame');
      const popupImage = document.getElementById('popupImage');
      const statusElement = document.getElementById('status');
      const downloadButton = document.getElementById('downloadButton');
      const quizContainer = document.getElementById('quizContainer');
      const downloadContainer = document.getElementById('downloadContainer');
      const backToListButton = document.getElementById('backToListButton');
      const backFromDownloadButton = document.getElementById('backFromDownloadButton');
      const finalDownloadButton = document.getElementById('finalDownloadButton');
      const quizProgressBar = document.getElementById('quizProgressBar');
      const quizProgressLabel = document.getElementById('quizProgressLabel');
      const quizScoreElement = document.getElementById('quizScore');
      const quizScoreContainer = document.getElementById('quizScoreContainer');
      const quizQuestions = document.querySelectorAll('.quiz-question');
      const soundElements = SOUND_ELEMENT_IDS.map(id => document.getElementById(id));

      // --- Stan Aplikacji ---
      let currentSound = null;
      let lastSoundIndex = -1;
      let mouseX = 0;
      let mouseY = 0;
      let currentQuestionIndex = 0;
      let quizScore = 0;
      let selectedGuest = null;
      let muted = false;
      let quizActive = false; // Flaga wskazująca, czy quiz jest aktywny

      // --- Szablon Zaproszenia (HTML jako string) ---
      // (Bez zmian w stosunku do oryginalnego kodu)
      const invitationTemplate = `
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Natalia & Konrad - Zaproszenie ślubne</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Italiana&family=Cormorant:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root { --primary-color: #2d2d2d; --accent-color: rgba(180, 160, 120, 0.7); --background-color: #ffffff; --spacing-unit: 7px; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background-color: var(--background-color); color: var(--primary-color); font-family: 'Cormorant', serif; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: calc(var(--spacing-unit) * 1); }
    .invitation-wrapper { position: relative; width: 105mm; height: 148mm; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.1); background-color: #fff; margin: 0 auto; }
    .invitation { position: relative; height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: calc(var(--spacing-unit) * 1.8); text-align: center; }
    .border-frame { position: absolute; top: calc(var(--spacing-unit) * 1.2); left: calc(var(--spacing-unit) * 1.2); right: calc(var(--spacing-unit) * 1.2); bottom: calc(var(--spacing-unit) * 1.2); border: 1px solid var(--accent-color); pointer-events: none; }
    .content { position: relative; width: 100%; max-width: 85mm; z-index: 2; display: flex; flex-direction: column; align-items: center; }
    .monogram-container { position: relative; margin: 0 auto calc(var(--spacing-unit) * 1.5); width: 120px; height: 70px; display: flex; align-items: center; justify-content: center; }
    .monogram-divider { position: absolute; height: 70px; width: 1px; background: linear-gradient(to bottom, transparent, var(--accent-color), transparent); left: 50%; top: 0; }
    .monogram { position: absolute; font-family: 'Italiana', serif; font-size: 60px; line-height: 1; color: var(--primary-color); }
    .n-letter { left: 8px; } .k-letter { right: 8px; }
    .names { font-family: 'Montserrat', sans-serif; font-size: 11px; letter-spacing: 1.5px; font-weight: 300; text-transform: uppercase; margin-bottom: calc(var(--spacing-unit) * 1.5); color: var(--primary-color); }
    .invite-text { font-size: 11px; line-height: 1.6; margin-bottom: calc(var(--spacing-unit) * 1.2); font-weight: 400; }
    .guest-name { font-style: italic; font-weight: 400; font-size: 13px; margin: calc(var(--spacing-unit) * 0.5) 0; color: var(--primary-color); display: block; }
    .date-container { display: flex; justify-content: center; align-items: center; margin: calc(var(--spacing-unit) * 1) 0; }
    .date-line { height: 1px; width: 40px; background-color: var(--primary-color); }
    .date { margin: 0 calc(var(--spacing-unit) * 1); font-size: 28px; font-weight: 400; font-family: 'Italiana', serif; }
    .date-details { display: flex; justify-content: space-between; width: 100%; max-width: 75mm; margin: 0 auto calc(var(--spacing-unit) * 0.8); font-family: 'Montserrat', sans-serif; font-size: 8px; letter-spacing: 1px; text-transform: uppercase; color: var(--primary-color); font-weight: 300; }
    .location { margin-top: calc(var(--spacing-unit) * 1.5); font-style: italic; font-size: 13px; line-height: 1.5; }
    .divider { height: 1px; width: 40px; background-color: var(--primary-color); margin: calc(var(--spacing-unit) * 1.5) auto; opacity: 0.5; }
    .reception-text { font-size: 11px; line-height: 1.5; margin-bottom: calc(var(--spacing-unit) * 1); font-weight: 400; }
    .reception-location { font-style: italic; font-size: 13px; line-height: 1.5; margin-bottom: calc(var(--spacing-unit) * 0.4); }
    .reception-address { font-size: 10px; line-height: 1.4; margin-bottom: calc(var(--spacing-unit) * 1); }
    @media print { body { background: none; padding: 0; margin: 0; font-size: initial; page-break-after: avoid; page-break-before: avoid; page-break-inside: avoid; } .invitation-wrapper { box-shadow: none; margin: 0 auto; width: 105mm; height: 148mm; page-break-after: avoid; page-break-before: avoid; page-break-inside: avoid; } @page { size: 105mm 148mm; margin: 0; } }
  </style>
</head>
<body>
  <div class="invitation-wrapper"> <div class="invitation"> <div class="border-frame"></div> <div class="content">
    <div class="monogram-container"><div class="monogram-divider"></div> <div class="monogram n-letter">N</div><div class="monogram k-letter">K</div></div>
    <div class="names">NATALIA ZAWADA I KONRAD DZIEDZIC</div>
    <div class="invite-text">z radością zapraszają<br><span class="guest-name">Martę i Jacka Nowaków</span>na uroczystość zaślubin,<br>która odbędzie się</div>
    <div class="date-container"><div class="date-line"></div><div class="date">9</div><div class="date-line"></div></div>
    <div class="date-details"><span>PAŹDZIERNIKA</span><span>2025</span><span>GODZ. 13:00</span></div>
    <div class="location">w Kościele św. Piotra i Pawła<br>w Skoczowie</div>
    <div class="divider"></div>
    <div class="reception-text">Po uroczystości zaślubin mamy zaszczyt zaprosić Was<br>na przyjęcie weselne, które odbędzie się</div>
    <div class="reception-location">w Winnicy Toskańskiej Romeo i Julia</div>
    <div class="reception-address">ul. Myśliwska 1, 43-370 Szczyrk</div>
  </div></div></div>
</body></html>`;

      // --- Funkcje Pomocnicze ---

      /** Funkcja Debounce ograniczająca częstotliwość wywołań */
      function debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
              const later = () => {
                  clearTimeout(timeout);
                  func(...args);
              };
              clearTimeout(timeout);
              timeout = setTimeout(later, wait);
          };
      }

      /** Aktualizuje pasek statusu */
      function updateStatus(message) {
          statusElement.textContent = message;
      }

      /** Odtwarza losowy dźwięk (jeśli nie jest wyciszony) */
      function playRandomSound() {
        if (muted || soundElements.length === 0) return;

        let soundIndex;
        // Prosta logika unikania powtórzeń
        do {
          soundIndex = Math.floor(Math.random() * soundElements.length);
        } while (soundElements.length > 1 && soundIndex === lastSoundIndex);

        lastSoundIndex = soundIndex;
        const sound = soundElements[soundIndex];

        if (!sound) {
          console.error(`Sound element with index ${soundIndex} not found.`);
          return;
        }

        // Zatrzymaj poprzedni dźwięk, jeśli gra
        if (currentSound && !currentSound.paused) {
          currentSound.pause();
          currentSound.currentTime = 0;
        }
        currentSound = sound;

        // Odtwarzanie dźwięku (może wymagać interakcji użytkownika w niektórych przeglądarkach)
        sound.play().then(() => {
          showPopupImage(); // Pokaż obrazek po udanym odtworzeniu
        }).catch(error => {
          // Ciche błędy autoplay są częste, nie trzeba logować za każdym razem
          // console.warn('Sound autoplay prevented:', error);
        });
      }

      /** Pokazuje popup z obrazkiem blisko kursora myszy */
      function showPopupImage() {
        if (POPUP_IMAGES.length === 0) return;

        const imageIndex = Math.floor(Math.random() * POPUP_IMAGES.length);
        popupImage.src = POPUP_IMAGES[imageIndex];

        const imgWidth = popupImage.offsetWidth || 250; // Przybliżona szerokość
        const imgHeight = popupImage.offsetHeight || 250; // Przybliżona wysokość
        const maxX = window.innerWidth - imgWidth - 10; // 10px marginesu
        const maxY = window.innerHeight - imgHeight - 10;

        // Pozycja blisko kursora, ale w granicach okna
        let posX = mouseX + (Math.random() * 100 - 50);
        let posY = mouseY + (Math.random() * 100 - 50);
        posX = Math.max(10, Math.min(posX, maxX));
        posY = Math.max(10, Math.min(posY, maxY));

        popupImage.style.left = `${posX}px`;
        popupImage.style.top = `${posY}px`;
        popupImage.classList.add('show');

        // Ukryj obrazek po 3 sekundach
        setTimeout(() => {
          popupImage.classList.remove('show');
        }, 3000);
      }

      // --- Funkcje Główne Aplikacji ---

      /** Renderuje listę gości w elemencie DOM */
      function renderGuestList(guests) {
        guestListElement.innerHTML = ''; // Wyczyść poprzednią listę

        if (guests.length === 0) {
          const noResultsItem = document.createElement('div');
          noResultsItem.classList.add('guest-item'); // Użyj tej samej klasy dla spójności
          noResultsItem.textContent = 'Brak pasujących gości';
          guestListElement.appendChild(noResultsItem);
          return;
        }

        guests.forEach(guest => {
          const guestItem = document.createElement('div');
          guestItem.classList.add('guest-item');
          guestItem.textContent = guest;
          guestItem.setAttribute('role', 'button'); // Lepsza semantyka
          guestItem.tabIndex = 0; // Umożliwia fokusowanie klawiaturą

          if (selectedGuest === guest) {
            guestItem.classList.add('selected');
            guestItem.setAttribute('aria-current', 'true'); // Wskazuje aktywny element
          }

          // Obsługa kliknięcia i naciśnięcia Enter/Space
          const selectAction = () => {
             if (selectedGuest !== guest) { // Unikaj niepotrzebnych aktualizacji
                selectGuest(guest);
                // Aktualizuj tylko zaznaczenie wizualne
                document.querySelectorAll('.guest-item.selected').forEach(item => {
                    item.classList.remove('selected');
                    item.removeAttribute('aria-current');
                 });
                 guestItem.classList.add('selected');
                 guestItem.setAttribute('aria-current', 'true');
             }
          };

          guestItem.addEventListener('click', selectAction);
          guestItem.addEventListener('keydown', (event) => {
             if (event.key === 'Enter' || event.key === ' ') {
                 event.preventDefault(); // Zapobiegaj domyślnej akcji (np. scroll)
                 selectAction();
             }
          });

          guestListElement.appendChild(guestItem);
        });
      }

      /** Wybiera gościa i aktualizuje podgląd */
      function selectGuest(guest) {
        selectedGuest = guest;
        updatePreview(guest);
        updateStatus(`Wybrano: ${guest}`);
      }

      /** Aktualizuje zawartość iframe z podglądem zaproszenia */
      function updatePreview(guest) {
        // Bezpieczniejsze zastępowanie - unikaj sytuacji, gdyby placeholder był częścią innego tekstu
        const placeholder = '<span class="guest-name">Martę i Jacka Nowaków</span>';
        const guestHtml = `<span class="guest-name">${guest}</span>`; // Tutaj można dodać ewentualne czyszczenie HTML gościa
        const finalHtml = invitationTemplate.replace(placeholder, guestHtml);

        // Użyj document.open/write/close lub srcdoc dla iframe
        try {
            // Preferowana metoda: srcdoc (lepsza izolacja i bezpieczeństwo)
            // previewFrame.srcdoc = finalHtml;
             // Metoda open/write/close (działa szerzej, ale mniej bezpieczna)
             const doc = previewFrame.contentDocument || previewFrame.contentWindow?.document;
             if (doc) {
                 doc.open();
                 doc.write(finalHtml);
                 doc.close();
             } else {
                 console.error("Nie można uzyskać dostępu do dokumentu iframe.");
                 // Fallback do data URI - może mieć ograniczenia długości
                 previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(finalHtml);
             }
        } catch (e) {
          console.error("Błąd podczas aktualizacji podglądu iframe:", e);
          updateStatus("Błąd podglądu.");
           // Fallback do data URI w razie błędu (np. cross-origin, chociaż tu nie powinien wystąpić)
           previewFrame.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(finalHtml);
        }
      }

      /** Resetuje stan quizu do początkowego */
        function resetQuiz() {
            currentQuestionIndex = 0;
            quizScore = 0;
            quizActive = false; // Quiz nie jest już aktywny

            quizScoreElement.textContent = `${quizScore}/${TOTAL_QUESTIONS}`;
            quizScoreContainer.style.display = 'none'; // Ukryj wynik

            quizProgressBar.style.width = '10%';
            quizProgressLabel.textContent = `Pytanie ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS}`;


            quizQuestions.forEach((question, index) => {
                question.style.display = index === 0 ? 'block' : 'none'; // Pokaż tylko pierwsze pytanie
                const options = question.querySelectorAll('.quiz-option');
                options.forEach(option => {
                    option.classList.remove('correct', 'incorrect');
                    option.disabled = false; // Odblokuj przyciski
                });
            });
        }

      /** Pokazuje następne pytanie lub kończy quiz */
      function showNextQuestion() {
        quizQuestions[currentQuestionIndex].style.display = 'none'; // Ukryj bieżące
        currentQuestionIndex++;

        if (currentQuestionIndex < TOTAL_QUESTIONS) {
          quizQuestions[currentQuestionIndex].style.display = 'block'; // Pokaż następne
          // Aktualizuj pasek postępu i etykietę
          const progress = ((currentQuestionIndex + 1) / TOTAL_QUESTIONS) * 100;
          quizProgressBar.style.width = `${progress}%`;
          quizProgressLabel.textContent = `Pytanie ${currentQuestionIndex + 1} / ${TOTAL_QUESTIONS}`;
        } else {
          // Koniec quizu
          quizActive = false; // Quiz zakończony
          quizScoreElement.textContent = `${quizScore}/${TOTAL_QUESTIONS}`;
          quizScoreContainer.style.display = 'block'; // Pokaż wynik
          showView('download'); // Pokaż ekran pobierania
        }
      }

       /** Obsługuje odpowiedź użytkownika w quizie */
        function handleQuizAnswer(optionButton, questionElement) {
            if (!quizActive) return; // Nie rób nic, jeśli quiz nie jest aktywny

            const isCorrect = optionButton.dataset.correct === 'true';
            const options = questionElement.querySelectorAll('.quiz-option');

            // Zablokuj wszystkie opcje dla tego pytania
            options.forEach(opt => opt.disabled = true);

            // Oznacz wybraną opcję
            optionButton.classList.add(isCorrect ? 'correct' : 'incorrect');

            if (isCorrect) {
                quizScore++;
            } else {
                // Jeśli odpowiedź jest błędna, znajdź i oznacz poprawną
                const correctOption = questionElement.querySelector('.quiz-option[data-correct="true"]');
                if (correctOption) {
                    correctOption.classList.add('correct');
                }
            }

            // Przejdź do następnego pytania po krótkim opóźnieniu
            setTimeout(showNextQuestion, 1200); // Daj chwilę na zobaczenie wyniku
        }


      /** Przełącza widok między listą, quizem i pobieraniem */
      function showView(viewName) {
          // Ukryj wszystkie kontenery widoków
          guestListElement.style.display = 'none';
          searchBox.style.display = 'none'; // Wyszukiwarka jest powiązana z listą
          quizContainer.style.display = 'none';
          downloadContainer.style.display = 'none';
          downloadButton.style.display = 'none'; // Ukryj główny przycisk pobierania

          // Pokaż wybrany widok
          if (viewName === 'list') {
              guestListElement.style.display = 'block';
              searchBox.style.display = 'block';
              downloadButton.style.display = 'inline-flex'; // Pokaż przycisk
              if (selectedGuest) {
                  updateStatus(`Wybrano: ${selectedGuest}`);
              } else {
                  updateStatus('Wybierz gościa z listy, aby zobaczyć podgląd zaproszenia.');
              }
              quizActive = false; // Upewnij się, że quiz nie jest aktywny
          } else if (viewName === 'quiz') {
              quizContainer.style.display = 'block';
              resetQuiz(); // Zresetuj quiz przy każdym pokazaniu
              updateStatus('Rozwiąż quiz, aby odblokować pobieranie wszystkich zaproszeń.');
              quizActive = true; // Oznacz quiz jako aktywny
          } else if (viewName === 'download') {
              downloadContainer.style.display = 'block';
              updateStatus('Quiz zakończony. Możesz teraz pobrać plik.');
              quizActive = false;
          }
      }


      // --- Inicjalizacja Aplikacji ---
      function init() {
        // 1. Renderowanie początkowej listy gości
        renderGuestList(GUEST_LIST_DATA);
        updateStatus('Wybierz gościa z listy, aby zobaczyć podgląd zaproszenia.'); // Początkowy status


        // 2. Obsługa wyszukiwania (z debounce)
        searchBox.addEventListener('input', debounce(() => {
          const searchTerm = searchBox.value.toLowerCase().trim();
          const filteredGuests = GUEST_LIST_DATA.filter(guest =>
            guest.toLowerCase().includes(searchTerm)
          );
          renderGuestList(filteredGuests);
        }, 300)); // Opóźnienie 300ms

        // 3. Obsługa przycisków nawigacyjnych
        downloadButton.addEventListener('click', () => showView('quiz'));
        backToListButton.addEventListener('click', () => showView('list'));
        backFromDownloadButton.addEventListener('click', () => showView('list'));

        // 4. Obsługa finalnego pobierania (symulacja)
        finalDownloadButton.addEventListener('click', (e) => {
          e.preventDefault();
          // W prawdziwej aplikacji tutaj byłby kod generujący i pobierający ZIP
          alert('Rozpoczynanie pobierania pliku ZIP z zaproszeniami...');
          // Można dodać np. zmianę tekstu przycisku na "Pobieranie..."
        });

        // 5. Inicjalizacja Quizu (dodanie listenerów do opcji)
          quizQuestions.forEach(questionElement => {
              const options = questionElement.querySelectorAll('.quiz-option');
              options.forEach(option => {
                  option.addEventListener('click', () => handleQuizAnswer(option, questionElement));
              });
          });

        // 6. Obsługa śledzenia myszy/dotyku dla popupu
        document.addEventListener('mousemove', (e) => {
          mouseX = e.clientX;
          mouseY = e.clientY;
        });
        document.addEventListener('touchmove', (e) => {
          if (e.touches.length > 0) {
            mouseX = e.touches[0].clientX;
            mouseY = e.touches[0].clientY;
          }
        });
        // Ustawienie początkowej pozycji myszy (na środku, jeśli nie było ruchu)
        mouseX = window.innerWidth / 2;
        mouseY = window.innerHeight / 2;


        // 7. Losowe dźwięki w interwałach (start po 5 sekundach)
        setTimeout(() => {
            setInterval(playRandomSound, 15000); // Co 15 sekund
        }, 5000);

        // 8. Obsługa skrótów klawiszowych
        document.addEventListener('keydown', (event) => {
          // Wyciszenie/Odciszenie (M)
          if (event.key.toLowerCase() === 'm') {
            muted = !muted;
            const muteStatus = muted ? 'Dźwięki wyciszone (naciśnij M ponownie)' : 'Dźwięki włączone (naciśnij M, aby wyciszyć)';
            // Wyświetl status tymczasowo
            const originalStatus = statusElement.textContent;
            updateStatus(muteStatus);
            setTimeout(() => updateStatus(originalStatus), 2500);
          }

          // Wyjście z quizu/pobierania (Escape)
          if (event.key === 'Escape') {
            if (quizContainer.style.display !== 'none' || downloadContainer.style.display !== 'none') {
              showView('list');
            }
          }
        });

        // 9. Obsługa zmiany rozmiaru okna (z debounce)
        window.addEventListener('resize', debounce(handleResize, 250));
        handleResize(); // Wywołaj raz na początku

        // 10. Dodatkowe animacje (jeśli są potrzebne)
        setupAnimations();

        // 11. Wstępne ładowanie dźwięków (przeglądarka i tak może to zignorować)
        soundElements.forEach(sound => sound?.load());

        console.log("Generator zaproszeń zainicjalizowany.");
      }

       /** Funkcja do obsługi responsywności - dostosowuje style na podstawie szerokości */
       function handleResize() {
           const width = window.innerWidth;
           const container = document.querySelector('.container');

           if (!container) return; // Zabezpieczenie

           // Przykładowe dostosowanie - usuń cień i zaokrąglenie na małych ekranach
           if (width < 768) {
               container.style.boxShadow = 'none';
               container.style.borderRadius = '0';
           } else {
               container.style.boxShadow = 'var(--shadow-lg)'; // Przywróć styl z CSS
               container.style.borderRadius = 'var(--radius-lg)';
           }
           // Tutaj można dodać inne dynamiczne zmiany stylów zależne od rozmiaru
       }

       /** Funkcja konfigurująca dodatkowe, drobne animacje/efekty UX */
       function setupAnimations() {
           // Animacja hover dla elementów listy (dodana w CSS, ale można tu dodać JS jeśli potrzeba)
           // console.log("Konfiguracja dodatkowych animacji (jeśli istnieją).");
           // Przykład: Dodanie klasy 'loaded' do body po inicjalizacji dla płynnego wejścia
            document.body.classList.add('loaded');
       }

      // --- Uruchomienie Inicjalizacji ---
      init();

    }); // Koniec 'DOMContentLoaded' listener
  </script>
</body>
</html>
